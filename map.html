<!DOCTYPE html>
<html>
<head>
    <title>License Plate Tracker Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Dark mode styling for the map and body */
        body {
            margin: 0;
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        h1 {
            margin-top: 20px;
            color: #ffffff;
        }
        #map {
            height: 80vh;
            width: 90vw;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <h1>License Plate Tracker</h1>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Airtable API Information
        const accessToken = 'YOUR_AIRTABLE_API_KEY'; // Replace with your Airtable API key
        const baseId = 'YOUR_AIRTABLE_BASE_ID'; // Replace with your Airtable Base ID
        const tableName = 'License Tracker'; // Your table name

        // Initialize Map with a dark-themed tile layer
        const map = L.map('map').setView([37.8, -96], 4); // Centered over North America

        // Using a dark-themed tile layer from CartoDB
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://carto.com/">CartoDB</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Function to create a color gradient based on value
        function getColor(value) {
            return value > 100 ? '#FF4500' : 
                   value > 75  ? '#FF6347' :
                   value > 50  ? '#FF7F50' :
                   value > 25  ? '#FF8C00' :
                   value > 10  ? '#FFA07A' :
                   value > 5   ? '#FFD700' :
                   value > 0   ? '#FFFFE0' :
                                 '#696969'; // Grey for no value
        }

        // Function to fetch data from Airtable
        async function fetchAirtableData() {
            const url = `https://api.airtable.com/v0/${baseId}/${tableName}`;
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await response.json();
            return data.records;
        }

        // Function to load the GeoJSON file and map all data
        async function addRegions() {
            try {
                // Fetch the GeoJSON data from the local file
                const geojsonResponse = await fetch('assets/other/updated_merged_geojson.json');
                const regions = await geojsonResponse.json();

                // Add the GeoJSON regions to the map
                const geoJsonLayer = L.geoJSON(regions, {
                    style: feature => ({
                        fillColor: '#696969', // Initial color (grey) before updating
                        weight: 1,
                        opacity: 0.7,
                        color: '#2F4F4F', // Dark slate grey border
                        dashArray: '3',
                        fillOpacity: 0.8
                    })
                }).addTo(map);

                // Fetch the data from Airtable
                const airtableRecords = await fetchAirtableData();

                // Create a map from Region name to Value
                const valueMap = {};
                airtableRecords.forEach(record => {
                    const regionName = record.fields['Region'];
                    const value = record.fields['Value'];
                    valueMap[regionName] = value;
                });

                // Update the colors of the GeoJSON regions based on the Airtable values
                geoJsonLayer.eachLayer(layer => {
                    const regionName = layer.feature.properties.name;
                    if (valueMap[regionName] !== undefined) {
                        const value = valueMap[regionName];
                        layer.setStyle({
                            fillColor: getColor(value)
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        addRegions();
    </script>
</body>
</html>
